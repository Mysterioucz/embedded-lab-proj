================================================================================
    ESP32 + STM32 NUCLEO F411RE SENSOR SYSTEM - COMPLETE SETUP GUIDE
================================================================================

Date: December 2024
System: IoT Sensor Hub with MQTT Communication

================================================================================
                            SYSTEM ARCHITECTURE
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMPLETE SYSTEM DIAGRAM                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   DHT11     â”‚ (Temperature & Humidity)
    â”‚  Sensor     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ PB5
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     LDR     â”‚â”€â”€â”€â”€â–ºâ”‚   ADC (PA0) â”‚  (Light Sensor)
    â”‚  + 10kÎ©     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   DS1302    â”‚
    â”‚  DS1302 RTC â”‚     â”‚   CLK: PB4  â”‚  (Real-Time Clock)
    â”‚  CLK â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºâ”‚   DAT: PB10 â”‚
    â”‚  DAT â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºâ”‚   RST: PA8  â”‚
    â”‚  RST â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   STM32 NUCLEO F411RE             â”‚
         â”‚                                    â”‚
         â”‚   â€¢ Reads all sensors             â”‚
         â”‚   â€¢ Formats JSON data             â”‚
         â”‚   â€¢ Sends via USART1              â”‚
         â”‚                                    â”‚
         â”‚   PA9 (TX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
         â”‚   PA10 (RX) â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
         â”‚   GND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚   â”‚   â”‚
                          GND RX  TX
                           â”‚   â”‚   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚   â”‚   â”‚        â”‚
         â”‚   GND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚        â”‚
         â”‚   GPIO16 (RX2) â”€â”€â”€â”€â”€â”˜   â”‚        â”‚
         â”‚   GPIO17 (TX2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
         â”‚                                    â”‚
         â”‚        ESP32 DEV MODULE           â”‚
         â”‚                                    â”‚
         â”‚   â€¢ Receives JSON via UART        â”‚
         â”‚   â€¢ Connects to WiFi              â”‚
         â”‚   â€¢ Publishes to MQTT             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ WiFi (2.4GHz)
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     WiFi Router / Access Point     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Network
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      Backend Server (Node.js)      â”‚
         â”‚                                     â”‚
         â”‚   â€¢ MQTT Broker (Port 1883)        â”‚
         â”‚   â€¢ MongoDB Database               â”‚
         â”‚   â€¢ WebSocket Server               â”‚
         â”‚   â€¢ REST API                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTP/WebSocket
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    Web Dashboard (React/Next.js)   â”‚
         â”‚                                     â”‚
         â”‚   â€¢ Real-time sensor display       â”‚
         â”‚   â€¢ Historical data charts         â”‚
         â”‚   â€¢ Alerts & notifications         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
                        HARDWARE CONNECTIONS
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. STM32 NUCLEO F411RE SENSORS                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DHT11 Temperature & Humidity Sensor:
    DHT11 Pin           STM32 Pin       Description
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    VCC                 3.3V            Power supply
    GND                 GND             Ground
    DATA                PB5             Data pin (bidirectional)

LDR Light Sensor (with voltage divider):
    Connection:
    3.3V â”€â”€â”¬â”€â”€â”€ LDR â”€â”€â”€â”¬â”€â”€â”€ ADC (PA0)
           â”‚           â”‚
           â”‚          10kÎ©
           â”‚           â”‚
          GND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€ GND

    Component           STM32 Pin       Description
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    LDR (top)           3.3V            Light dependent resistor
    ADC (middle)        PA0             Analog input
    10kÎ© (bottom)       GND             Pull-down resistor

DS1302 Real-Time Clock:
    DS1302 Pin          STM32 Pin       Description
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    VCC                 3.3V or 5V      Power supply
    GND                 GND             Ground
    CLK (SCLK)          PB4             Clock signal
    DAT (I/O)           PB10            Data (bidirectional)
    RST (CE)            PA8             Chip enable/reset

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. STM32 TO ESP32 UART CONNECTION                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    STM32 Nucleo F411RE         ESP32 Dev Module
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    PA9  (USART1 TX)    â”€â”€â”€â”€â–º   GPIO16 (RX2)
    PA10 (USART1 RX)    â—„â”€â”€â”€â”€   GPIO17 (TX2)
    GND                 â”€â”€â”€â”€â”€â”€â”€â”€  GND

    [Optional: 3.3V power sharing if using same supply]
    3.3V                â”€â”€â”€â”€â”€â”€â”€â”€  3.3V

âš ï¸  IMPORTANT:
    - TX connects to RX, RX connects to TX (crossover connection)
    - Both devices must share common ground (GND)
    - Both use 3.3V logic levels (compatible)
    - Baud rate: 115200 (must match on both sides)

================================================================================
                        SOFTWARE CONFIGURATION
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. STM32 CONFIGURATION (STM32CubeIDE)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Required Peripherals:
    - USART1: 115200 baud, 8N1 (for ESP32 communication)
    - USART2: 115200 baud, 8N1 (for USB debugging)
    - ADC1: PA0 channel (for LDR)
    - GPIO: PB5, PB4, PB10, PA8 (for DHT11 and DS1302)

GPIO Pin Configuration:
    PA0  - Analog Input (ADC1_IN0)
    PA8  - Output (DS1302 RST)
    PA9  - USART1_TX
    PA10 - USART1_RX
    PB4  - Output (DS1302 CLK)
    PB5  - Bidirectional (DHT11 DATA - dynamically switched)
    PB10 - Bidirectional (DS1302 DAT - dynamically switched)

Code Requirements:
    - Enable float printf in project settings
    - Enable DWT for microsecond delays
    - JSON format: {"temp":25.5,"hum":60.0,"lux":450.0,"time":"08/12/2024 11:40:00"}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ESP32 CONFIGURATION (Arduino IDE)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Arduino IDE Setup:
    1. Add ESP32 board support:
       File â†’ Preferences â†’ Additional Board Manager URLs:
       https://dl.espressif.com/dl/package_esp32_index.json

    2. Install ESP32 boards:
       Tools â†’ Board â†’ Board Manager â†’ Search "esp32" â†’ Install

    3. Install libraries:
       - PubSubClient (by Nick O'Leary)
       - ArduinoJson (by Benoit Blanchon) v6.x

Board Settings:
    Board: "ESP32 Dev Module" (or your specific ESP32 board)
    Upload Speed: 921600
    CPU Frequency: 240MHz
    Flash Frequency: 80MHz
    Flash Mode: QIO
    Flash Size: 4MB (or as per your module)
    Partition Scheme: Default 4MB
    Port: Select your COM port

Code Configuration (esp32_sensor.ino):
    Line 28-29:  Update WiFi credentials
        const char* ssid = "YOUR_WIFI_SSID";
        const char* password = "YOUR_WIFI_PASSWORD";

    Line 31:     Update backend server IP
        const char* mqtt_server = "192.168.1.100";

    Line 34:     Update sensor ID (optional)
        const char* sensor_id = "nucleo-f411re-001";

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. BACKEND SERVER CONFIGURATION (Node.js)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Prerequisites:
    - Node.js v16 or later
    - MongoDB (local or cloud)
    - npm or yarn

Installation Steps:
    1. Navigate to backend directory:
       cd embedded-lab-proj/backend

    2. Install dependencies:
       npm install

    3. Configure environment (.env file):
       PORT=3001
       MONGODB_URI=mongodb://localhost:27017/sensor-dashboard
       MQTT_PORT=1883
       NODE_ENV=development

    4. Start the server:
       npm start

    5. Verify MQTT broker is running:
       Server should show: "ğŸš€ MQTT Broker running on port 1883"

Testing MQTT Connection:
    # Using mosquitto command line tools:
    mosquitto_sub -h localhost -t "home/sensors/#" -v

    # Or use MQTT Explorer GUI:
    Download from: http://mqtt-explorer.com/

================================================================================
                        DATA FLOW & JSON FORMAT
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATA FORMAT AT EACH STAGE                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 1: STM32 â†’ ESP32 (via UART)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Format: Simple JSON with sensor readings
Example:
{
  "temp": 25.5,
  "hum": 60.0,
  "lux": 450.0,
  "time": "08/12/2024 11:40:00"
}

Stage 2: ESP32 â†’ Backend (via MQTT)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Format: Enhanced JSON with metadata
Topic: home/sensors/esp32
Example:
{
  "sensorId": "nucleo-f411re-001",
  "temperature": 25.5,
  "humidity": 60.0,
  "light": 450.0,
  "time": "08/12/2024 11:40:00",
  "timestamp": 1234567890,
  "rssi": -67,
  "source": "nucleo-f411re"
}

Stage 3: Backend â†’ Database (MongoDB)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Format: Document with processing metadata
Example:
{
  "_id": ObjectId("..."),
  "topic": "home/sensors/esp32",
  "sensorId": "nucleo-f411re-001",
  "temperature": 25.5,
  "humidity": 60.0,
  "light": 450.0,
  "timestamp": ISODate("2024-12-08T11:40:00.000Z"),
  "data": { /* original data */ },
  "createdAt": ISODate("2024-12-08T11:40:00.000Z")
}

Stage 4: Backend â†’ Frontend (via WebSocket)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Format: Real-time event with formatted data
Event: "sensor-data"
Example:
{
  "topic": "home/sensors/esp32",
  "data": {
    "sensorId": "nucleo-f411re-001",
    "temperature": 25.5,
    "humidity": 60.0,
    "light": 450.0,
    "time": "08/12/2024 11:40:00"
  }
}

================================================================================
                        TESTING & VERIFICATION
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP-BY-STEP TESTING PROCEDURE                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Test 1: STM32 Sensor Reading
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Connect STM32 to PC via USB
2. Open serial terminal (e.g., PuTTY, Tera Term)
3. Settings: 115200 baud, 8N1
4. You should see JSON data every 2 seconds:
   âœ… PASS: JSON appears with sensor values
   âŒ FAIL: No output â†’ Check USART2 configuration

Test 2: ESP32 WiFi Connection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Upload code to ESP32
2. Open Arduino Serial Monitor (115200 baud)
3. Look for:
   âœ… PASS: "âœ… WiFi connected successfully!"
   âŒ FAIL: "âŒ WiFi connection failed!" â†’ Check SSID/password

Test 3: UART Communication
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Connect STM32 TX to ESP32 RX (PA9 â†’ GPIO16)
2. Connect STM32 RX to ESP32 TX (PA10 â†’ GPIO17)
3. Connect GND to GND
4. Check ESP32 Serial Monitor for:
   âœ… PASS: "ğŸ“¨ Received from STM32: {json data}"
   âŒ FAIL: No data â†’ Check wiring, swap TX/RX if needed

Test 4: MQTT Connection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Ensure backend server is running
2. Check ESP32 Serial Monitor for:
   âœ… PASS: "âœ… Connected!" to MQTT
   âŒ FAIL: "âŒ Failed, rc=..." â†’ Check server IP/firewall

Test 5: Data Publishing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Use MQTT Explorer or mosquitto_sub
2. Subscribe to topic: home/sensors/#
3. Look for incoming messages
   âœ… PASS: Messages appear with sensor data
   âŒ FAIL: No messages â†’ Check MQTT connection

Test 6: Backend Processing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Check backend console for:
   "ğŸ“© Received on topic 'home/sensors/esp32'"
   "ğŸ’¾ Saved to database"
   âœ… PASS: Data is being processed
   âŒ FAIL: Check backend logs for errors

Test 7: Database Storage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Open MongoDB Compass or mongo shell
2. Query database: db.sensordatas.find().limit(5)
3. Check for recent entries
   âœ… PASS: Data is being stored
   âŒ FAIL: Check MongoDB connection

Test 8: Frontend Display
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Open web browser
2. Navigate to: http://localhost:3000
3. Check for real-time data updates
   âœ… PASS: Dashboard shows live sensor data
   âŒ FAIL: Check WebSocket connection

================================================================================
                        TROUBLESHOOTING GUIDE
================================================================================

Problem: STM32 not sending data
Solution:
  â–¡ Check USART1 is configured (not just USART2)
  â–¡ Verify PA9/PA10 are set to USART1_TX/RX
  â–¡ Check JSON formatting is correct
  â–¡ Enable float printf in project settings
  â–¡ Verify sensors are connected and responding

Problem: ESP32 not receiving data
Solution:
  â–¡ Verify UART wiring (TXâ†’RX, RXâ†’TX, GNDâ†’GND)
  â–¡ Check baud rate matches (115200 on both)
  â–¡ Swap TX/RX connections if still not working
  â–¡ Test with logic analyzer if available
  â–¡ Check voltage levels are compatible (both 3.3V)

Problem: WiFi connection fails
Solution:
  â–¡ Use 2.4GHz WiFi (ESP32 doesn't support 5GHz)
  â–¡ Check SSID and password are correct (case-sensitive)
  â–¡ Move ESP32 closer to router
  â–¡ Check WiFi isn't using special characters
  â–¡ Try different WiFi network

Problem: MQTT connection fails
Solution:
  â–¡ Verify backend server is running
  â–¡ Check server IP address is correct
  â–¡ Ensure port 1883 is not blocked by firewall
  â–¡ Test with: telnet <server_ip> 1883
  â–¡ Check server logs for connection attempts
  â–¡ Try connecting with MQTT Explorer first

Problem: JSON parsing errors
Solution:
  â–¡ Check JSON format matches expected structure
  â–¡ Verify STM32 sends complete JSON (ends with \n)
  â–¡ Look for buffer overflow warnings
  â–¡ Test JSON at: https://jsonlint.com/
  â–¡ Print raw UART data to debug format

Problem: High packet loss
Solution:
  â–¡ Check WiFi signal strength (RSSI value)
  â–¡ Reduce data transmission rate on STM32
  â–¡ Increase MQTT keepalive timeout
  â–¡ Check network congestion
  â–¡ Use QoS level 1 or 2 for MQTT

Problem: LDR readings too high/low
Solution:
  â–¡ Verify LDR wiring configuration (top or bottom)
  â–¡ Check 10kÎ© resistor value with multimeter
  â–¡ Calibrate formula based on known light levels
  â–¡ Use logarithmic formula instead of linear
  â–¡ Test in different lighting conditions

Problem: DS1302 time not syncing
Solution:
  â–¡ Set initial time in DS1302_Init() function
  â–¡ Use BCD format (0x11 = 11, not 11 decimal)
  â–¡ Check DS1302 battery (if coin cell present)
  â–¡ Verify CLK, DAT, RST connections
  â–¡ Check for timing issues (use oscilloscope)

================================================================================
                        PERFORMANCE OPTIMIZATION
================================================================================

ESP32 Power Saving:
  - Use WiFi.setSleep(WIFI_PS_NONE) for lowest latency
  - Or WiFi.setSleep(WIFI_PS_MIN_MODEM) for power saving
  - Implement deep sleep between transmissions if battery powered

STM32 Optimization:
  - Reduce sensor polling rate if CPU usage is high
  - Use DMA for UART transmission
  - Implement sensor error handling and retries

Network Optimization:
  - Use MQTT QoS 0 for real-time data (fastest)
  - Use MQTT QoS 1 for important data (acknowledged)
  - Enable MQTT keep-alive (default 60s is good)
  - Compress JSON if bandwidth is limited

Database Optimization:
  - Create indexes on timestamp and sensorId fields
  - Implement data aggregation for historical views
  - Set up automatic data archival for old records
  - Use capped collections for recent data

================================================================================
                        SECURITY CONSIDERATIONS
================================================================================

Network Security:
  â˜‘ Use WPA2/WPA3 for WiFi
  â˜‘ Change default MQTT broker port if exposed to internet
  â˜‘ Implement MQTT authentication (username/password)
  â˜‘ Use TLS/SSL for MQTT in production (port 8883)
  â˜‘ Set up firewall rules to restrict access

Application Security:
  â˜‘ Don't hardcode WiFi credentials in production
  â˜‘ Use environment variables for sensitive data
  â˜‘ Implement rate limiting on backend API
  â˜‘ Validate and sanitize all input data
  â˜‘ Use HTTPS for web dashboard

Data Security:
  â˜‘ Encrypt MongoDB connection string
  â˜‘ Enable MongoDB authentication
  â˜‘ Regular database backups
  â˜‘ Implement user authentication for dashboard
  â˜‘ Log all access attempts

================================================================================
                        MAINTENANCE & MONITORING
================================================================================

Regular Checks:
  â–¡ Monitor ESP32 RSSI (signal strength)
  â–¡ Check MQTT packet success rate
  â–¡ Monitor database size and growth
  â–¡ Review error logs weekly
  â–¡ Update firmware periodically
  â–¡ Test sensor calibration monthly

Logging:
  - ESP32: Serial output (can add SD card logging)
  - Backend: Winston logger with daily rotation
  - Database: Enable MongoDB audit logging
  - Frontend: Browser console errors

Alerts:
  - Set up alerts for device disconnections
  - Monitor data gaps (no data for >5 minutes)
  - Alert on abnormal sensor readings
  - CPU/memory usage thresholds on backend

================================================================================
                        ADDITIONAL RESOURCES
================================================================================

Documentation:
  - STM32 HAL Library: https://www.st.com/en/embedded-software/stm32cube.html
  - ESP32 Arduino Core: https://docs.espressif.com/projects/arduino-esp32/
  - PubSubClient: https://pubsubclient.knolleary.net/
  - ArduinoJson: https://arduinojson.org/
  - MQTT Protocol: https://mqtt.org/

Tools:
  - MQTT Explorer: http://mqtt-explorer.com/
  - MongoDB Compass: https://www.mongodb.com/products/compass
  - Postman: For testing REST APIs
  - Wireshark: For network packet analysis
  - Logic Analyzer: For debugging UART/I2C/SPI

Community:
  - ESP32 Forum: https://esp32.com/
  - STM32 Community: https://community.st.com/
  - Arduino Forum: https://forum.arduino.cc/
  - Stack Overflow: Tag [esp32], [stm32], [mqtt]

================================================================================
                        PROJECT CHECKLIST
================================================================================

Hardware Setup:
  â–¡ All sensors connected to STM32
  â–¡ STM32 to ESP32 UART wired correctly
  â–¡ Power supply adequate for all components
  â–¡ Common ground established between all devices

Software Setup:
  â–¡ STM32 code compiled and uploaded
  â–¡ ESP32 code configured and uploaded
  â–¡ Backend server running and MQTT broker active
  â–¡ MongoDB connected and accessible
  â–¡ Frontend dashboard built and accessible

Testing:
  â–¡ STM32 sensors reading correctly
  â–¡ UART communication verified
  â–¡ WiFi connection stable
  â–¡ MQTT publishing successful
  â–¡ Data appearing in database
  â–¡ Dashboard showing real-time updates

Documentation:
  â–¡ Pin connections documented
  â–¡ Configuration settings noted
  â–¡ Known issues logged
  â–¡ Calibration values recorded

================================================================================
                        SUPPORT CONTACT
================================================================================

For issues with this setup guide or system implementation:
  - Check troubleshooting section first
  - Review backend and ESP32 console logs
  - Test each component individually
  - Document error messages and steps to reproduce

Version: 1.0
Last Updated: December 2024
Author: ESP32-STM32 IoT Project Team

================================================================================
                        END OF SETUP GUIDE
================================================================================
